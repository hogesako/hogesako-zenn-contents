---
title: "ISUCON13にくすサポISUCON部として参加し、147,649点で9位でした"
emoji: "🦑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: [isucon]
published: false
---
ISUCON13にくすサポISUCON部として参加し、147,649点で9位でした。
やったことなどは[@tondolが書いてくれた](https://scrapbox.io/tondol-pub/ISUCON13%E3%81%AB%E3%81%8F%E3%81%99%E3%82%B5%E3%83%9DISUCON%E9%83%A8%E3%81%A8%E3%81%97%E3%81%A6%E5%8F%82%E5%8A%A0%E3%81%97%E3%80%819%E4%BD%8D%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%97%E3%81%9F)ので、別の内容を書こうと思います。

## チームの特色
### 使用ツール一覧
以下のようなツールを利用しています。
|tool|用途|
|---|---|
|VS Code RemoteSSH|サーバ上で直接ソースコード・configを編集するスタイル|
|Makefile| nginx,golang,mysqlのデプロイからalp,pt-query-digestの集計などをまとめている|
|alp| nginxのログ集計|
|pt-query-digest| MySQLのスロークエリログ集計。原則0秒に設定して全クエリ集計しています|
|htop|プロセスごとのリソース使用状況確認用。サーバ全体のCPU・メモリ使用状況は出ているのでこれだけ眺めていることが多かった|
|dstat|リソース使用状況確認。今回はこれが必要になるまで到達できなかった。|

### VS Code RemoteSSH
うちのチームはVS Code RemoteSSHでサーバ直作業派です。
メリットは以下のようなものがあります。
1. ローカル環境を構築するなどをせずにいきなり改善に入れ、そのまま環境差異など気にせずに動作確認を行えること
2. alp, pt-query-digestの結果をそのまま閲覧できること
3. 1人1台のサーバを保有し、お試しで編集してデプロイ。ベンチマークが通ることと、ボトルネックが解消されたことを確認してからcommit・PRという流れが行いやすいこと

デメリットとしては以下のようなものがあります。
1. 複数台構成になってきたあたりで「いま1号機壊れてるからベンチマークちょっと待って！！」みたいな状況がたまに発生する
2. git configのuser,emailが最初に設定した人のものになりがち^[だいたいtondolになる]
3. ISUCON12の時代はGolangのLanguage Serverを定期的に再起動しないとたまにサーバ自体が無応答になっていた（ISUCON13ではまったくなくてよかった）

このやりかたに強いこだわりがあるわけでもなく、もっといい方法があったら試してみたい気持ちはあります。

### 役割分担・作業の進め方
最近は以下のような分担になっています。

* アプリ専任1名(tondol)
* インフラ & SQLインデックス担当（すっちー）
* アプリやりつつインフラの相談役（hogesako・自分）

インフラ作業に関しては1人なのでほぼおまかせ、たまに相談があったら聞くぐらいの分担です。
アプリに関しては2人いるので、alpの1番重いエンドポイントと2番めに重いエンドポイントを「自分このエンドポイントやるわ」という宣言制ですすめていく感じでした。

## ISUCON 3つの壁
ISUCON7からISUCON11までは予選を突破することができず、最近やっと本戦にも出られるようになった自分たちとしては、以下の3つの壁があるように感じています
1. 予選通過(TOP30)の壁
2. 賞金(3位)の壁
3. 優勝の壁

### 1. 予選通過(TOP30)の壁
明確なボトルネックの壁と言ってもいいのかもしれません。
自分たちは後述する3つの内容を徹底するようにした結果、突破できるようになったと考えています。

#### ボトルネックから対処する
10:00にISUCONが始まると刻々と時間が過ぎ、他チームが順調にスコアを伸ばしていくと、焦りと緊張で混乱してしまいますよね。
そのときにソースコードを眺めていると、「明らかに遅そうな処理」、「有名なアンチパターン」、「最近自分が実務で解決した遅かった処理」、「最近学んだ新技術が適用できる処理」、「簡単にできるような改善」のような、飛びつきたくなる魅力的な処理があるものです。
その処理に飛びつきたい欲望をぐっとこらえて、alpで一番重いエンドポイント、pt-query-digestで上位に来ているクエリから対処できるようになると、どんどんスコアが伸びていくようになりました。^[なお、エンドポイント内のどの処理を修正するかはわりと推測だったりします。典型的なN+1などではpt-query-digestの情報と突き合わせできてしまうことも多いのと、後述の「ボトルネックが解消されたことを確認する」で正しかったか確認できるためです。本当に困った時用にOpenTelemetry・Jeagerの準備はしていましたが、今回は使いませんでした。]

#### ボトルネックを潰す
そして、当然のことながらボトルネックがわかっていても改善できなければ意味がありません。
自分は実務ではJavaしかつかっていないので、ISUCONでは慣れていない言語を利用する必要があります。
わかんねーと思いつつ、典型的なN+1の改善や、メモリへのキャッシュ、Redisの利用方法などはISUCON開催日の数週間前までに過去問を解いておくことによって、Golangとしての書き方を脳味噌のキャッシュに乗せておくというのも非常に大事だったように思います。

といっても去年の優勝チームNaruseJunのとーふとふさんの記事の通り、「[チューニングのレパートリーを増やす練習](https://zenn.dev/tohutohu/articles/8c34d1187e1b21#isucon%E3%81%A7%E5%8B%9D%E3%81%A4%E3%81%9F%E3%82%81%E3%81%AB)」をやっているだけなんですけどね。

#### ボトルネックが解消されたことを確認する
自分たちは「[貼っていたはずのインデックスが貼れていなかった(※20時15分のところです)](https://tondol.hatenablog.jp/entry/kususapo-isucon-10)」^[いまみてもコミットコメントが焦りすぎている]、「クエリチューニングしたけど実は早くなっていなかった」、「デプロイするのを忘れていた」みたいなことをやらかしすぎています。

やらかしすぎたことにより、以下のような内容を徹底しています。
* インデックスを貼る前後で `EXPLAIN ANALYZE` で実時間ベースで早くなっていることを確認する
* インデックスを貼った後のベンチマークではpt-query-digestの上位から消えている、もしくは少なくともExec TimeやRows examineが改善していることを確認する
* クエリを変更するときも変更前後で `EXPLAIN ANALYE` して実時間ベースで早くなっていることを確認する 
* アプリ改善後のベンチマークでは、改修したエンドポイントがalpの上位から消えていること、もしくは少なくともレスポンスタイムが改善していることを確認する

#### 予選通過(TOP30)の壁 まとめ
まとめると以下の3つです。
* alp,pt-query-digestでボトルネック上位のものから対応する
* 典型的なボトルネックに対しては数週間前に素振りをして改善方法を脳内キャッシュに載せておく
* チューニングした結果、alp,pt-query-digestからボトルネックが解消されたことまで確認する

まじで当たり前のことしか書いていないですが、やっぱり当たり前のことって大事だと思うんですよね^[ただし、これを全員ができるようになってしまうと予選突破のボーダーが上がってしまう。[ISUCON4 予選でアプリケーションを変更せずに予選通過ラインを突破するの術](https://kazeburo.hatenablog.com/entry/2014/10/14/170129)という記事がありましたが、ISUCON13では流石に多分おそらく無理であるように・・・。]。

### 2. 賞金(3位)の壁
ボトルネックを粗方潰し終わったあとの壁と言ってもいいのかもしれません。いま自分たちがぶち当たっている壁もここです。
alpの上位エンドポイントの処理を読んでも悪くない順当な処理に見える、pt-query-digestの上位ももうだいたいできることはやったみたいな状況です。

自分たちはISUCON12の本戦ではこの状況から何もできなくて、感想戦でちょっとだけ分かり始めた気がしています（※まだぜんぜんわかっていない）

この段階になってくるとはじめて
* 各サーバのリソース状況を見てボトルネックを考え始める
* オンメモリキャッシュ
* unix domainsocket化

あたりが効き始める雰囲気を感じ取っています（「ボトルネックから対処する」のが大事と書いているのに論理的に説明できるところまで到達していない）

自分たちの場合は、やることがわからないというよりは「予選通過(TOP30)の壁」を突破するまでに時間をかけすぎている感があります。
そのため、「チューニングのレパートリー」を増やしつつ、実装速度を上げていかなければならないのかなと考えています。

### 3. 優勝の壁
配信で優勝チームが約47万点だと言われたときはまじで信じられませんでした。
今回であれば、20万点台まではめちゃくちゃ努力すれば8時間で到達できそうな可能性を感じるのだけれど、47万点はもう一つひとつ壁がある気がしています。
ここから先は本当にわからん、わからん、わからーーん！！。

## くやしさの維持方法（怨念）
実はISUCONで一番モチベーションが高いのはISUCON結果発表直後という説があります（優勝者以外）。
なぜならいちばんくやしさを感じているからです。そして、くやしさは1年経つと薄れがちな気もします。
このくやしさを消えないうちにどう使うかが大事な気がしています。

> ISUCON14はもうはじまっちゃっているっていうこと、なんだよね（関暁夫）。

自分はこのくやしさを怨念に変え、反省点とその対策、来年も絶対やるべきことくらいは「秘伝のタレ」スプレッドシートに残すようにしています。
![](/images/isucon13/onnen.png)
*怨念*

## おわりに
運営の皆さん、作問・練習環境提供のさくらインターネットさん、競技環境提供のAWSさん、スポンサーの皆さん、[matsuu/cloud-init-isucon](https://github.com/matsuu/cloud-init-isucon/) をメンテしてくださっているmatsuuさん、ありがとうございました！！
